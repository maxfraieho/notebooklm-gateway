
ТИ — SENIOR CLOUDFLARE WORKERS ENGINEER + INTEGRATION ARCHITECT.

КОНТЕКСТ:
Є існуючий Cloudflare Worker “Garden MCP Worker v3.0” (vanilla ES2022, KV, JWT owner auth, MinIO S3 SigV4 upload/delete).
Файл воркера: /home/vokov/projects/notebooklm/cloudflare_worker/index.js
Деплой воркера вже є: https://garden-mcp-server.maxfraieho.workers.dev/

Ми додали окремий NotebookLM backend (FastAPI), який доступний через Cloudflare Tunnel:
- NOTEBOOKLM_BASE_URL = "<Я ДАМ ТОБІ URL ТУНЕЛЯ/СЕРВІСУ ПІСЛЯ ЦЬОГО>"

ЦІЛЬ:
Додати у Worker потрібний функціонал, щоб фронтенд (Lovable React) міг:
1) Створювати Zone (як і зараз)
2) Опційно — створювати NotebookLM notebook для цієї Zone + імпортувати sources (notes.md/json/jsonl з MinIO) + (опційно) робити share
3) Отримувати notebook URL / статус import job для polling

ОБМЕЖЕННЯ:
- Не додавати зовнішніх залежностей (тільки чистий JS у Worker).
- Не ламати існуючі endpoints.
- Secrets НЕ хардкодити у коді. Всі креденшали/токени/ключі — тільки через Cloudflare env vars/secrets.
- PostgreSQL не використовуємо (у Worker і так KV).
- MinIO креденшали НЕ виводити в лог і не вшивати в код.

---

## ✅ Потрібні env vars у Cloudflare Worker
Додай в документацію/README (або коментар на початку файлу) список env vars:

- NOTEBOOKLM_BASE_URL="https://notebooklm.exodus.pp.ua" (або tunnel URL)
- NOTEBOOKLM_SERVICE_TOKEN (optional; якщо backend підтримує Bearer token)
- NOTEBOOKLM_TIMEOUT_MS=15000 (optional)

(існуючі вже є: MINIO_ENDPOINT, MINIO_BUCKET, MINIO_ACCESS_KEY, MINIO_SECRET_KEY, JWT_SECRET, KV)

ВАЖЛИВО:
- якщо NOTEBOOKLM_SERVICE_TOKEN заданий — додавати header Authorization: Bearer ...
- якщо не заданий — робити запит без Authorization (MVP)

---

## ✅ НОВИЙ FLOW: Zone → NotebookLM

### Розширити endpoint POST /zones/create
Зараз body має: { name, description, allowedPaths, ttlMinutes, notes, accessType }
Додай опційні поля:
- createNotebookLM: boolean
- notebookTitle?: string
- notebookShareEmails?: string[]
- notebookSourceMode?: "minio"|"url" (default "minio")

Поведінка:
- якщо createNotebookLM=false або відсутній → нічого не змінюємо
- якщо createNotebookLM=true:
  1) Zone створюється як і зараз (KV + MinIO upload notes.*)
  2) Worker викликає NotebookLM backend:
     - POST {NOTEBOOKLM_BASE_URL}/v1/notebooks  body: { "title": notebookTitle || name }
     - POST {NOTEBOOKLM_BASE_URL}/v1/notebooks/{id}/sources/import  body:
         якщо notebookSourceMode="minio":
           { "sources":[{"type":"minio","bucket": env.MINIO_BUCKET, "key": `zones/${zoneId}/notes.md`}] , "idempotency_key": `zone-${zoneId}-import` }
         якщо notebookSourceMode="url":
           { "sources":[{"type":"url","url": "<public or signed url>" }], "idempotency_key": ... }
     - (optional) POST {NOTEBOOKLM_BASE_URL}/v1/notebooks/{id}/share body: { emails, role:"reader" }
  3) Worker зберігає mapping у KV:
     key: `zone_notebooklm:${zoneId}`
     value: {
       zoneId,
       notebookId,
       notebookUrl,
       importJobId,
       status: "queued|running|completed|failed",
       createdAt,
       lastError?
     }
  4) Worker повертає в response /zones/create:
     notebooklm: { notebookId, notebookUrl, importJobId, status }

ВАЖЛИВО:
- Якщо NotebookLM backend недоступний або падає:
  - Zone все одно створюємо
  - notebooklm.status="failed" + reason
  - і записуємо KV mapping з помилкою

---

## ✅ ДОДАТКОВІ ENDPOINTS У WORKER

1) GET /zones/:zoneId/notebooklm
- Публічний (або owner-only — запропонуй що краще) endpoint
- Повертає mapping з KV (notebookUrl, status, importJobId, lastError)

2) POST /zones/:zoneId/notebooklm/retry-import
- owner-only (через Bearer JWT як у protected routes)
- Перезапускає import:
  - знову викликає /sources/import з idempotency_key (наприклад zone-${zoneId}-import-retry-${timestamp})
  - оновлює KV mapping

3) (Опційно) GET /zones/:zoneId/notebooklm/job/:jobId
- Проксі до {NOTEBOOKLM_BASE_URL}/v1/jobs/{jobId}
- Щоб фронту було простіше робити polling через один домен воркера.

---

## ✅ Реалізаційні вимоги

- Створи helper: fetchNotebookLM(env, path, {method, body}) з timeout і нормалізацією помилок.
- Дотримуйся існуючого стилю jsonResponse/errorResponse.
- Додай unified error для нових endpoint’ів у форматі воркера (success:false/error).
- Не змінюй існуючі MinIO upload/delete функції, лише використай їх outputs (bucket/key).
- KV ключі:
  - zone_notebooklm:{zoneId}
  - (optional) notebooklm_job:{jobId} якщо треба кешувати

---

## ✅ ACCEPTANCE CRITERIA

- /zones/create працює як і раніше без createNotebookLM
- якщо createNotebookLM=true:
  - створюється KV mapping zone_notebooklm:{zoneId}
  - в response повертається notebooklm {notebookUrl, importJobId, status}
- /zones/:zoneId/notebooklm повертає стан
- retry-import працює (owner-only)
- (optional) job proxy працює
- secrets не присутні в коді і не логуються

---

## ✅ Що видати у відповіді
1) Конкретний diff/patch змін у index.js (або опис змін по блоках, але краще diff)
2) Список env vars + як додати їх через wrangler (БЕЗ значень)
3) 3 приклади curl:
   - створення zone без notebooklm
   - створення zone з notebooklm
   - перевірка статусу notebooklm

ПОЧИНАЙ: відкрий файл /home/vokov/projects/notebooklm/cloudflare_worker/index.js, внеси зміни, і підготуй патч.


* `NOTEBOOKLM_BASE_URL = https://garden-mcp-server.maxfraieho.workers.dev/`



* Minio адресу apiminio.exodus.pp.ua перевыр в коды воркера маэ бути. Пароль 805235io логін vokov 